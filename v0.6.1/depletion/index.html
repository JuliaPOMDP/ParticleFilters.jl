<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Handling Particle Depletion · ParticleFilters.jl</title><meta name="title" content="Handling Particle Depletion · ParticleFilters.jl"/><meta property="og:title" content="Handling Particle Depletion · ParticleFilters.jl"/><meta property="twitter:title" content="Handling Particle Depletion · ParticleFilters.jl"/><meta name="description" content="Documentation for ParticleFilters.jl."/><meta property="og:description" content="Documentation for ParticleFilters.jl."/><meta property="twitter:description" content="Documentation for ParticleFilters.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">ParticleFilters.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../bootstrap/">Bootstrap Filter</a></li><li><a class="tocitem" href="../beliefs/">Beliefs</a></li><li><a class="tocitem" href="../basic/">Basic Particle Filter</a></li><li class="is-active"><a class="tocitem" href>Handling Particle Depletion</a><ul class="internal"><li><a class="tocitem" href="#Example"><span>Example</span></a></li><li><a class="tocitem" href="#Additional-Examples-of-Postprocessing-Functions"><span>Additional Examples of Postprocessing Functions</span></a></li></ul></li><li><a class="tocitem" href="../sampling/">Sampling</a></li><li><a class="tocitem" href="../example-filtering/">Example: Filtering Preexisting Data</a></li><li><a class="tocitem" href="../example-feedback/">Example: Feedback Control</a></li><li><a class="tocitem" href="../example-pomdps/">Example: Use with POMDPs.jl</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Handling Particle Depletion</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Handling Particle Depletion</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaPOMDP/ParticleFilters.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaPOMDP/ParticleFilters.jl/blob/master/docs/src/depletion.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Handling-Particle-Depletion"><a class="docs-heading-anchor" href="#Handling-Particle-Depletion">Handling Particle Depletion</a><a id="Handling-Particle-Depletion-1"></a><a class="docs-heading-anchor-permalink" href="#Handling-Particle-Depletion" title="Permalink"></a></h1><p>Many of the most common problems with particle filters are related to particle depletion, that is, a lack of particles corresponding to the true state. In many cases, it is not difficult to overcome these problems, but domain-specific heuristics are often more effective than generic approaches.</p><p>The recommended way to handle particle depletion in a <a href="../bootstrap/#ParticleFilters.BootstrapFilter"><code>BootstrapFilter</code></a> or <a href="../basic/#ParticleFilters.BasicParticleFilter"><code>BasicParticleFilter</code></a> is to add a postprocessing step. In the <code>BasicParticleFilter</code>, this is a required argument; in the <code>BootstrapFilter</code>, it is an optional keyword argument.</p><p>A postprocessing function takes 6 arguments:</p><pre><code class="language-julia hljs">postprocess(bp, a, o, b, bb, rng)</code></pre><p><code>bp</code> is the new belief, <code>a</code> is the action, <code>o</code> is the observation, <code>b</code> is the old belief, <code>bb</code> is the belief after preprocessing, and <code>rng</code> is the random number generator. See the <a href="../basic/#Basic-Particle-Filter">Basic Particle Filter</a> section to see where <code>postprocess</code> is called in the code. The postprocessing function should return the modified belief. This can be the same object <code>bp</code> modified in place or a new object.</p><div class="admonition is-success"><header class="admonition-header">Tip</header><div class="admonition-body"><p>If you don&#39;t need all of the arguments, you can use the splat operator <code>...</code> to ignore them, e.g. <code>postprocess(bp, a, o, args...)</code>.</p></div></div><div class="admonition is-success"><header class="admonition-header">Tip</header><div class="admonition-body"><p>The function does not need to be named <code>postprocess</code>. It can have any name or be anonymous.</p></div></div><p>Creating a postprocessing function is best illustrated by a simple example:</p><h2 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h2><p>In this example, we have a system with integer states states and actions, deterministic dynamics, and an observation that is uniformly distributed over the current state plus or minus 1. If all state particles start 1, action 1 is taken, and observation 4 is received, then no particles are consistent with the observation. This will yield a warning about particle depletion and produce a belief with zero-weighted particles that cannot be sampled from or used effectively: </p><pre><code class="language-julia hljs">using ParticleFilters, Distributions

dynamics(s, a, rng) = s + a
likelihood(s_previous, a, s, o) = abs(o - s) &lt;= 1
naive_pf = BootstrapFilter(dynamics, likelihood, 3)

b0 = ParticleCollection([1, 1, 1])
a = 1
o = 4

bp = update(naive_pf, b0, a, o)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"><span class="sgr33"><span class="sgr1">┌ Warning: </span></span>Sum of particle filter weights is not greater than zero. This
<span class="sgr33"><span class="sgr1">│ </span></span>could be due to particle depletion. See the documentation of the
<span class="sgr33"><span class="sgr1">│ </span></span>ParticleFilters package for instructions on handling particle depletion.
<span class="sgr33"><span class="sgr1">│ </span></span>  weight_sum(b) = 0.0
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ ParticleFilters ~/work/ParticleFilters.jl/ParticleFilters.jl/src/postprocessing.jl:8</span></code></pre><p>To fix this, we define a postprocessing step to refill the particle belief with particles consistent with the observation:</p><pre><code class="language-julia hljs">function refill_with_consistent(bp, a, o, b, bb, rng)
    if weight_sum(bp) == 0.0
        return WeightedParticleBelief([o-1, o, o+1], ones(3))
    else
        return bp
    end
end</code></pre><p>Note that this solution is <em>very</em> domain-specific. It relies on specific knowledge about the observation function. In other applications, you will likely need to be clever about coming up with ways to create replacement particles in cases of depletion. Armed with the new postprocessing step, we can create a new filter and use it for a belief update:</p><pre><code class="language-julia hljs">pf = BootstrapFilter(dynamics, likelihood, 3; postprocess=refill_with_consistent)
bp = update(pf, b0, a, o)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">WeightedParticleBelief{Int64}([3, 4, 5], [1.0, 1.0, 1.0], 3.0, nothing, nothing)</code></pre><p>While this new belief is consistent with the observation, it does not take into account the dynamics or information from the previous steps. A better solution might be to populate the new belief with particles as near as possible to the previous particles while still being consistent with the observation. Tricks like this are often necessary to get good performance in practice and they are an important part of the art of particle filtering.</p><h2 id="Additional-Examples-of-Postprocessing-Functions"><a class="docs-heading-anchor" href="#Additional-Examples-of-Postprocessing-Functions">Additional Examples of Postprocessing Functions</a><a id="Additional-Examples-of-Postprocessing-Functions-1"></a><a class="docs-heading-anchor-permalink" href="#Additional-Examples-of-Postprocessing-Functions" title="Permalink"></a></h2><p>The following section provides additional examples of strategies that commonly work well and additional postprocessing functions.</p><h3 id="Replacing-Zero-Weight-Particles"><a class="docs-heading-anchor" href="#Replacing-Zero-Weight-Particles">Replacing Zero-Weight Particles</a><a id="Replacing-Zero-Weight-Particles-1"></a><a class="docs-heading-anchor-permalink" href="#Replacing-Zero-Weight-Particles" title="Permalink"></a></h3><p>Rather than waiting until all particle weights are zero, it is often effective to replace zero-weight particles as soon as they are detected. If a function <code>consistent_state(o, rng)</code> is written to generate states consistent with the observation, this replacement can be accomplished with the following postprocessing function:</p><pre><code class="language-julia hljs">function replace_zero_weight_particles(bp, a, o, b, bb, rng)

    n = n_particles(bp)
    new_weight = weight_sum(bp)/n

    for i in 1:n
        if weight(bp, i) == 0.0
            s = consistent_state(o, rng)
            set_pair!(bp, i, s =&gt; new_weight)
        end
    end

    return bp
end</code></pre><h3 id="Adding-Artificial-Noise"><a class="docs-heading-anchor" href="#Adding-Artificial-Noise">Adding Artificial Noise</a><a id="Adding-Artificial-Noise-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-Artificial-Noise" title="Permalink"></a></h3><p>In continuous-state systems with deterministic dynamics, it can be useful to add artificial noise to the states as follows:</p><pre><code class="language-julia hljs">function add_noise(bp, a, o, b, bb, rng)
    for i in 1:n_particles(bp)
        p = particle(bp, i)
        set_particle!(bp, i, p + 0.1*randn(rng))
    end
    return bp
end</code></pre><h3 id="Combining-Multiple-Postprocessing-Steps"><a class="docs-heading-anchor" href="#Combining-Multiple-Postprocessing-Steps">Combining Multiple Postprocessing Steps</a><a id="Combining-Multiple-Postprocessing-Steps-1"></a><a class="docs-heading-anchor-permalink" href="#Combining-Multiple-Postprocessing-Steps" title="Permalink"></a></h3><p>It is often useful to combine multiple postprocessing steps. This can be accomplished convenienttly with the <code>PostprocessChain</code> function:</p><pre><code class="nohighlight hljs">PostprocessChain(replace_zero_weight_particles, add_noise)</code></pre><h3 id="Replacing-Zero-Weight-Particles-with-States-from-the-Initial-Distribution"><a class="docs-heading-anchor" href="#Replacing-Zero-Weight-Particles-with-States-from-the-Initial-Distribution">Replacing Zero-Weight Particles with States from the Initial Distribution</a><a id="Replacing-Zero-Weight-Particles-with-States-from-the-Initial-Distribution-1"></a><a class="docs-heading-anchor-permalink" href="#Replacing-Zero-Weight-Particles-with-States-from-the-Initial-Distribution" title="Permalink"></a></h3><p>If no other information is available, a quick solution is to replace zero-weight particles with states drawn from the initial distribution. In POMDPs.jl, the <code>initialstate</code> function can be used to generate these states. This implementation uses a callable object to store the POMDP model.</p><pre><code class="language-julia hljs">using ParticleFilters, POMDPs, POMDPModels

struct ReplaceWithInitial{M &lt;: POMDP} &lt;: Function
    m::M
    threshold::Float64 # replace particles with normalized weights below this
end

function (r::ReplaceWithInitial)(bp, a, o, b, bb, rng)
    ws = weights(bp)
    wsum = weight_sum(bp)
    nws = ws ./ wsum
    n = n_particles(bp)
    for i in 1:n
        if nws[i] &lt; r.threshold
            set_pair!(bp, i, rand(rng, initial_state(r.m)) =&gt; wsum/n)
        end
    end
    return bp
end</code></pre><p>The filter can then be created as follows:</p><pre><code class="language-julia hljs">m = TigerPOMDP()
pf = BootstrapFilter(m, 1, postprocess=ReplaceWithInitial(m, 0.1))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">BasicParticleFilter{ParticleFilters.NormalizedESSConditionalResampler{typeof(low_variance_sample)}, ParticleFilters.POMDPPredictor{POMDPModels.TigerPOMDP}, ParticleFilters.POMDPReweighter{POMDPModels.TigerPOMDP}, ParticleFilters.var&quot;#21#23&quot;{Main.ReplaceWithInitial{POMDPModels.TigerPOMDP}, typeof(check_particle_belief)}, ParticleFilters.var&quot;#25#28&quot;{Int64}, Random.TaskLocalRNG}(ParticleFilters.NormalizedESSConditionalResampler{typeof(low_variance_sample)}(ParticleFilters.low_variance_sample, 1, 0.9), ParticleFilters.POMDPPredictor{POMDPModels.TigerPOMDP}(POMDPModels.TigerPOMDP(-1.0, -100.0, 10.0, 0.85, 0.95)), ParticleFilters.POMDPReweighter{POMDPModels.TigerPOMDP}(POMDPModels.TigerPOMDP(-1.0, -100.0, 10.0, 0.85, 0.95)), ParticleFilters.var&quot;#21#23&quot;{Main.ReplaceWithInitial{POMDPModels.TigerPOMDP}, typeof(check_particle_belief)}(Main.ReplaceWithInitial{POMDPModels.TigerPOMDP}(POMDPModels.TigerPOMDP(-1.0, -100.0, 10.0, 0.85, 0.95), 0.1), ParticleFilters.check_particle_belief), ParticleFilters.var&quot;#25#28&quot;{Int64}(1), Random.TaskLocalRNG())</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../basic/">« Basic Particle Filter</a><a class="docs-footer-nextpage" href="../sampling/">Sampling »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.10.2 on <span class="colophon-date" title="Saturday 26 April 2025 18:12">Saturday 26 April 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
